CREATE DATABASE DuAn1Nhom102
GO
USE DuAn1Nhom102
--thêm bảng loại món ăn, bỏ đệ quy
--1. Loai
CREATE TABLE Loai
	(
		IdLoai UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		IdDanhMuc UNIQUEIDENTIFIER NOT NULL,
		MaLoai  VARCHAR(20) UNIQUE NOT NULL,
		TenLoai NVARCHAR(150) NOT NULL,
		TrangThai INT DEFAULT NULL
	)
--2.TABLE KHÁCH HÀNG
CREATE TABLE Khach_Hang
	(
		IdKH UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		MaKH VARCHAR(20) UNIQUE NOT NULL,
		Ho NVARCHAR(20) DEFAULT NULL,
		TenDem NVARCHAR(100) DEFAULT NULL,
		Ten NVARCHAR(20) DEFAULT NULL,
		GioiTinh NVARCHAR(20) DEFAULT NULL,
		NgaySinh DATE DEFAULT NULL,
		Sdt VARCHAR(15) DEFAULT NULL,
		DiaChi NVARCHAR(150) DEFAULT NULL,
		ThanhPho NVARCHAR(100) DEFAULT NULL,
		QuocGia NVARCHAR(100) DEFAULT NULL,
		TrangThai INT DEFAULT 0
	)
--3.TABLE BÀN
CREATE TABLE Ban
	(
		IdBan UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		IdKhuVuc UNIQUEIDENTIFIER NOT NULL,
		MaBan INT UNIQUE NOT NULL,
		SoLuongChoNgoi INT NOT NULL,
		TrangThai INT DEFAULT 0
	)
--4.Thêm bảng Khu vực (3)
CREATE TABLE Khu_Vuc
	(
		IdKhuVuc UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		MaKhuVuc VARCHAR(20) UNIQUE NOT NULL,
		TenKhuVuc NVARCHAR(100) NOT NULL,
		TrangThai INT DEFAULT 0
	)
--5.Hoá Đơn
CREATE TABLE Hoa_Don
	(
		IdHD UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		IdNV UNIQUEIDENTIFIER NOT NULL,
		IdKH UNIQUEIDENTIFIER DEFAULT NULL,
		MaHD VARCHAR(20) UNIQUE NOT NULL,
		NgayTao DATE NOT NULL,
		NgayThanhToan DATE DEFAULT NULL,
		TongTien DECIMAL(20,0) DEFAULT 0,
		GhiChu NVARCHAR(200) DEFAULT NULL,
		TrangThai INT DEFAULT 0
	)
	--6.Giao dịch
CREATE TABLE Giao_Dich
	(
		Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		IdHD UNIQUEIDENTIFIER NOT NULL,
		HinhThucThanhToan NVARCHAR(200) NOT NULL,
		SoTienThanhToan DECIMAL(20,0) DEFAULT 0
	)
--7.Combo --run r nma có cần thêm số combo sẽ bán ko-- ko cần thêm đâu ngu shiii
CREATE TABLE Combo
	(
		IdCombo UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		IdNV UNIQUEIDENTIFIER NOT NULL,
		MaCB VARCHAR(20) UNIQUE NOT NULL,
		TenCB NVARCHAR(150) NOT NULL,
		HinhAnh VARCHAR(255) DEFAULT NULL,
		DonGia DECIMAL(20,0) NOT NULL,
		TrangThai INT DEFAULT 0
	)
--8.Chi_Tiet_Combo
CREATE TABLE  Chi_Tiet_Combo
	(
		Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		IdCombo UNIQUEIDENTIFIER NOT NULL,
		IdMonAn UNIQUEIDENTIFIER NOT NULL,
		SoLuongMonAn INT NOT NULL,
	)
--9.Hoa_Don_Chi_Tiet 
CREATE TABLE Hoa_Don_Chi_Tiet
	(
		IdHDCT UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		IdMonAn UNIQUEIDENTIFIER DEFAULT NULL, 
		IdHD UNIQUEIDENTIFIER NOT NULL,
		IdCombo UNIQUEIDENTIFIER DEFAULT NULL,
		SoLuongMonAn INT NOT NULL,
		DonGiaMonAn DECIMAL(20,0) NOT NULL,
		SoLuongCombo INT NOT NULL,
		DonGiaCombo DECIMAL(20,0) NOT NULL
	)
--10.Nhan_Vien
CREATE TABLE Nhan_Vien
	(
		IdNV UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		IdCV UNIQUEIDENTIFIER NOT NULL,
		MaNV VARCHAR(20) UNIQUE NOT NULL,
		Ho NVARCHAR(20) NOT NULL,
		TenDem NVARCHAR(100) NOT NULL,
		Ten NVARCHAR(20) NOT NULL,
		GioiTinh NVARCHAR(20) DEFAULT NULL,
		Sdt VARCHAR(15) NOT NULL,
		Email VARCHAR(100) DEFAULT NULL,
		NgaySinh DATE NOT NULL,
		DiaChi NVARCHAR(200) NOT NULL,
		MatKhau VARCHAR(70) NOT NULL,
		TrangThai INT DEFAULT 0
	)
--11.Mon_An
CREATE TABLE Mon_An 
	(
		IdMonAn UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		IdLoai UNIQUEIDENTIFIER NOT NULL,
		IdKM UNIQUEIDENTIFIER DEFAULT NULL,
		MaMonAn VARCHAR(20) UNIQUE NOT NULL,
		TenMonAn NVARCHAR(150) NOT NULL,
		HinhAnh VARCHAR(255) DEFAULT NULL,
		DonGia DECIMAL(20,0) NOT NULL,
		DonViTinh NVARCHAR(50) NOT NULL,
		TrangThai INT DEFAULT 0
	)
--12.KhuyenMai 
CREATE TABLE Khuyen_Mai
	(
		IdKM UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		IdNV UNIQUEIDENTIFIER NOT NULL,
		MaKM VARCHAR(20) UNIQUE NOT NULL,
		TenKM NVARCHAR(50) NOT NULL,
		ThoiGianBD DATE NOT NULL,
		ThoiGianKT DATE NOT NULL,
		LoaiKM NVARCHAR(50) NOT NULL,
		GtriKM DECIMAL(20,0) DEFAULT 0,
		GhiChu NVARCHAR(200) DEFAULT NULL,
		TrangThai INT DEFAULT 0 
	)
----12. Ca_Lam_Viec
--CREATE TABLE Ca_Lam_Viec
--	(
--		IdCaLamViec UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
--		IdNV UNIQUEIDENTIFIER NOT NULL,
--		TgianBD DATETIME NOT NULL,
--		TgianKT DATETIME DEFAULT NULL,
--		TienDauCa DECIMAL(20,0) DEFAULT 0,
--		TienMatTaiQuan DECIMAL(20,0) NOT NULL,
--		TienNhoThuHo DECIMAL(20,0) DEFAULT 0,
--		GhiChu NVARCHAR(200)
--	)

--13.Chuc_Vu
CREATE TABLE Chuc_Vu
	(
		IdCV UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		MaCV VARCHAR(20) UNIQUE NOT NULL,
		TenCV NVARCHAR(100) NOT NULL,
		TrangThai INT DEFAULT 0
	)
--14.Danh mục
CREATE TABLE Danh_Muc
	(
		IdDanhMuc UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
		MaDanhMuc VARCHAR(20) UNIQUE NOT NULL,
		TenDanhMuc NVARCHAR(200) NOT NULL,
		TrangThai INT DEFAULT 0
	)
-- 15 chi_tiet_ban_hoaDon
create table Chi_Tiet_Ban_HoaDon(
	Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
	IdBan UNIQUEIDENTIFIER NOT NULL,
	IdHoaDon UNIQUEIDENTIFIER NOT NULL
)



---Quan hệ giữua các bảng:
ALTER TABLE Chi_Tiet_Ban_HoaDon ADD CONSTRAINT FK_Chi_Tiet_Ban_HoaDon_Ban FOREIGN KEY (IdBan) REFERENCES Ban(IdBan)
ALTER TABLE Chi_Tiet_Ban_HoaDon ADD CONSTRAINT FK_Chi_Tiet_Ban_HoaDon_HoaDon FOREIGN KEY (IdHoaDon) REFERENCES Hoa_Don(IdHD)

ALTER TABLE Loai ADD CONSTRAINT FK_DanhMuc FOREIGN KEY (IdDanhMuc) REFERENCES Danh_Muc(IdDanhMuc)

ALTER TABLE Khuyen_Mai ADD CONSTRAINT FK_NVTaoKM FOREIGN KEY (IdNV) REFERENCES Nhan_Vien(IdNV)

ALTER TABLE Nhan_Vien ADD CONSTRAINT FK_CV FOREIGN KEY (IdCV) REFERENCES Chuc_Vu(IdCV)
ALTER TABLE Hoa_Don_Chi_Tiet ADD CONSTRAINT FK_MonAn_HDCT FOREIGN KEY(IdMonAn) REFERENCES Mon_An(IdMonAn)
ALTER TABLE Hoa_Don_Chi_Tiet ADD CONSTRAINT FK_HD_HDCT FOREIGN KEY(IdHD) REFERENCES Hoa_Don(IdHD)
ALTER TABLE Hoa_Don_Chi_Tiet ADD CONSTRAINT FK_Combo_HDCT FOREIGN KEY(IdCombo) REFERENCES Combo(IdCombo)
ALTER TABLE Chi_Tiet_Combo ADD CONSTRAINT FK_ComboCT FOREIGN KEY (IdCombo) REFERENCES Combo(IdCombo)
ALTER TABLE Chi_Tiet_Combo ADD CONSTRAINT FK_MonAnCombo FOREIGN KEY (IdMonAn) REFERENCES Mon_An(IdMonAn)
ALTER TABLE Hoa_Don ADD CONSTRAINT FK_NV_HD FOREIGN KEY (IdNV) REFERENCES Nhan_Vien(IdNV)
ALTER TABLE Hoa_Don ADD CONSTRAINT FK_KH_HD FOREIGN KEY (IdKH) REFERENCES Khach_Hang(IdKH)
ALTER TABLE Combo ADD CONSTRAINT FK_NV_Combo FOREIGN KEY (IdNV) REFERENCES Nhan_Vien(IdNV)
ALTER TABLE Ban ADD CONSTRAINT FK_KhuVuc FOREIGN KEY(IdKhuVuc) REFERENCES Khu_Vuc(IdKhuVuc)
ALTER TABLE Mon_An ADD CONSTRAINT FK_Loai_monAN FOREIGN KEY(IdLoai) REFERENCES Loai(IdLoai)
ALTER TABLE Mon_An ADD CONSTRAINT FK_KM FOREIGN KEY (IdKM) REFERENCES Khuyen_Mai(IdKM)
ALTER TABLE Giao_Dich ADD CONSTRAINT FK_HD FOREIGN KEY(IdHD) REFERENCES Hoa_Don(IdHD)

--INSERT Dữ Liệu
--khu vực
INSERT INTO Khu_Vuc(MaKhuVuc, TenKhuVuc, TrangThai) VALUES
	('KV1', N'Trên cây', 0),
	('KV2', N'Ngoài sân', 0)
	select * from Khu_Vuc
--bàn
INSERT INTO Ban (IdKhuVuc, MaBan, SoLuongChoNgoi,TrangThai) VALUES
	('F55FF8E2-8AD4-412E-B969-0FC58E3FF9A7', 1, 10, 0)
INSERT INTO Ban (IdKhuVuc, MaBan, SoLuongChoNgoi,TrangThai) VALUES
	('2E4745A5-080E-425B-9963-E345730DC146', 2, 5, 0),
	('BD112274-913F-4152-8946-4DC63401821B', 3, 5, 0)
--chức vụ
INSERT INTO Chuc_Vu (MaCV,TenCV,  TrangThai) VALUES
	('CV1', N'Nhân Viên', 0),
	('CV2', N'Quản lý', 0)
	select * from Chuc_Vu
--nhân viên
INSERT INTO Nhan_Vien(IdCV, MaNV, Ho, TenDem,Ten,GioiTinh, Sdt,Email, NgaySinh, DiaChi, MatKhau, TrangThai) VALUES
	('28D24C5B-A4E6-4CFB-ADC3-141D370E453A','NV1', N'Nguyễn', N'Đức', N'Dụng', N'Nam', '0339927992',
	'dungndph20697@fpt.edu.vn', '2003-04-22', N'Bắc Ninh', '123', 0)
--danh mục:
SELECT * FROM Danh_Muc
INSERT INTO Danh_Muc (MaDanhMuc,TenDanhMuc,TrangThai) VALUES
	('DM1',N'Đồ ăn', 0)
INSERT INTO Danh_Muc (MaDanhMuc,TenDanhMuc,TrangThai) VALUES
	('DM2',N'Đồ uống', 0)
--loại:
select * from Loai
INSERT INTO Loai (IdDanhMuc, MaLoai, TenLoai, TrangThai) VALUES
	('663EB364-9DC3-41F8-8A3D-81AFF3FC92FD', 'L1', N'Nướng',0)
INSERT INTO Loai (IdDanhMuc, MaLoai, TenLoai, TrangThai) VALUES
	('663EB364-9DC3-41F8-8A3D-81AFF3FC92FD', 'L2', N'Hấp',0)
INSERT INTO Loai (IdDanhMuc, MaLoai, TenLoai, TrangThai) VALUES
	('412BDFD9-DE19-43EA-8741-8318EEF3F895', 'L3', N'Đồ uống có ga',0)
INSERT INTO Loai (IdDanhMuc, MaLoai, TenLoai, TrangThai) VALUES
	('412BDFD9-DE19-43EA-8741-8318EEF3F895', 'L4', N'Đồ uống ko ga',0)
--món ăn
SELECT * FROM Loai
INSERT INTO Mon_An(IdLoai, MaMonAn, TenMonAn, DonGia, DonViTinh, TrangThai) VALUES
	('E505CFAA-C0ED-4C61-A6A5-AC13F752EF22', 'MA1', N'Hàu nướng',200, N'Đĩa', 0)
INSERT INTO Mon_An(IdLoai, MaMonAn, TenMonAn, DonGia, DonViTinh, TrangThai) VALUES
	('77A40C5F-66F3-4FFA-9E6C-74C44C7DFA4E', 'MA2', N'Hàu hấp',250, N'Đĩa', 0)
INSERT INTO Mon_An(IdLoai, MaMonAn, TenMonAn, DonGia, DonViTinh, TrangThai) VALUES
	('F1A0DE8E-D392-4F4D-BDDA-567E34B602C9', 'MA3', N'pepsi',10, N'chai', 0)
INSERT INTO Mon_An(IdLoai, MaMonAn, TenMonAn, DonGia, DonViTinh, TrangThai) VALUES
	('AFE0E417-54B9-4D61-8044-3E75D9A94E28', 'MA4', N'lavie',5, N'chai', 0)
	select * from Mon_An
--combo
select * from Nhan_Vien
INSERT INTO Combo(IdNV, MaCB, TenCB, DonGia, TrangThai) VALUES
	('465E87D3-9842-4666-9D65-5F9025F4A282','CB1', N'Combo 255k', 255, 0 )
INSERT INTO Combo(IdNV, MaCB, TenCB, DonGia, TrangThai) VALUES
	('465E87D3-9842-4666-9D65-5F9025F4A282','CB2', N'Combo 215k', 215, 0 )
	select * from Combo
--chi tiết combo
INSERT INTO Chi_Tiet_Combo (IdCombo,IdMonAn, SoLuongMonAn) VALUES
	('AACBB9C5-3D96-4CCC-9EC9-70B70B25F97D','DC3BF662-6915-43C4-9F13-4629BCF10F7E', 1)
INSERT INTO Chi_Tiet_Combo (IdCombo,IdMonAn, SoLuongMonAn) VALUES
	('AACBB9C5-3D96-4CCC-9EC9-70B70B25F97D','DEFD2FE2-DDB3-4C6A-B45F-8A2637EB3121', 2)
INSERT INTO Chi_Tiet_Combo (IdCombo,IdMonAn, SoLuongMonAn) VALUES
	('4C09C663-EEDE-46DE-A053-B09074074D66','78D3188F-F52B-4AC8-A05F-4D0D39E728A2', 1)
INSERT INTO Chi_Tiet_Combo (IdCombo,IdMonAn, SoLuongMonAn) VALUES
	('4C09C663-EEDE-46DE-A053-B09074074D66','56ABB956-3D4F-4788-AD17-3D010EABBEF5', 2)
--Khach hàng

INSERT INTO Khach_Hang (MaKH, Ho, TenDem, Ten, GioiTinh, NgaySinh, Sdt, DiaChi, ThanhPho,QuocGia, TrangThai) VALUES
	('KH1', N'Nguyễn', N'Anh', N'Dũng', N'Nam', '2003-11-29', '0384910040', N'Tuyên Quang', N'Tuyên Quang',
		N'Việt Nam', 0)
--khuyến mãi:
INSERT INTO Khuyen_Mai (IdNV, MaKM, TenKM, ThoiGianBD, ThoiGianKT, LoaiKM, GtriKM, GhiChu, TrangThai) VALUES
	('465E87D3-9842-4666-9D65-5F9025F4A282', 'KM1', N'Khuyến mãi 1','2022-11-16', '2022-11-18', N'Giá tiền',10, N'Áp dụng với sp có giá >100k', 0)

--select* from Khu_Vuc
--select * from Ban
--select * from Chuc_Vu
--select * from Nhan_Vien
select * from Danh_Muc
--select * from Combo
--select * from Mon_An
--select * from Chi_Tiet_Combo
--insert Khach_Hang(MaKH) values('KH02')
--insert into Danh_Muc(IdLoai,MaDanhMuc,TenDanhMuc) values('AA5EF128-4354-4917-9C5D-9E19B52F1C3F','DM03',N'Nước uống có ga')
--select * from Hoa_Don
--select * from Khach_Hang


select * from Mon_An inner join Loai  on Mon_An.IdLoai= Loai.IdLoai where Loai.IdDanhMuc in (select IdDanhMuc from 
Danh_Muc where MaDanhMuc = 'DM1')
SELECT * FROM Khu_Vuc
SELECT * FROM Ban
SELECT * FROM Chuc_Vu
SELECT * FROM Nhan_Vien
SELECT * FROM Danh_Muc
SELECT * FROM Loai
SELECT * FROM Mon_An
SELECT * FROM Combo
SELECT * FROM Chi_Tiet_Combo
SELECT * FROM Khach_Hang
SELECT * FROM Khuyen_Mai
select * from Danh_Muc
select * from hoa_don
select * from Giao_Dich
select * from Hoa_Don
select * from Chi_Tiet_Ban_HoaDon
delete from Chi_Tiet_Ban_HoaDon
delete from Hoa_Don
update Ban set TrangThai = 0
delete from Hoa_Don_Chi_Tiet

